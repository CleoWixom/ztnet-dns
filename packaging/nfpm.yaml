# packaging/nfpm.yaml
# Used by command: PKG_VERSION=x.y.z nfpm package --config packaging/nfpm.yaml --packager deb
# Docs: https://nfpm.goreleaser.com/configuration/

name: coredns-ztnet
arch: amd64
platform: linux
version: "${PKG_VERSION}"   # injected from env in CI

maintainer: "CleoWixom <noreply@github.com>"
description: |
  CoreDNS with ztnet plugin.
  Authoritative DNS server for ZeroTier networks via ZTNET REST API.
  Provides A/AAAA records for ZT members without file writes or restarts.
vendor: "CleoWixom"
homepage: "https://github.com/CleoWixom/ztnet-dns"
license: "Apache-2.0"

# deb section — package metadata
deb:
  # Compression: xz gives the smallest size
  compression: xz
  fields:
    # Package replaces system coredns if already installed
    Conflicts: coredns
    Provides: coredns

contents:
  # ── Binary ─────────────────────────────────────────────────────────────
  - src: /tmp/coredns-bin
    dst: /usr/sbin/coredns
    file_info:
      mode: 0755
      owner: root
      group: root

  # ── Corefile example (config — not overwritten on upgrade) ─────────────
  - src: Corefile.example
    dst: /etc/coredns/Corefile
    type: config|noreplace
    file_info:
      mode: 0640
      owner: root
      group: root

  # ── Secret directory (token) ────────────────────────────────────────────
  - dst: /etc/coredns/secrets
    type: dir
    file_info:
      mode: 0700
      owner: root
      group: root


  # ── Helper script for secure token install/rotation ─────────────────────
  - src: packaging/ztnetool
    dst: /usr/bin/ztnetool
    file_info:
      mode: 0755
      owner: root
      group: root

  # ── Systemd unit ─────────────────────────────────────────────────────────
  - src: packaging/coredns-ztnet.service
    dst: /lib/systemd/system/coredns-ztnet.service
    file_info:
      mode: 0644
      owner: root
      group: root

scripts:
  # postinstall: setcap for port 53 without root, enable + start service
  postinstall: packaging/scripts/postinstall.sh
  preremove: packaging/scripts/preremove.sh
