#!/usr/bin/env bash
set -euo pipefail

REPO_URL="https://github.com/CleoWixom/ztnet-dns.git"
WORKDIR=""
DELETE_MODE=false
IPV6_DISABLE=false
ZT_FULL=false

export ZONE="${ZONE:-ztnet.local}"
export EXITNODE_IPV4="${EXITNODE_IPV4:-192.168.55.1}"
export EXITNODE_IPV6="${EXITNODE_IPV6:-fc4e:1d7b:a5ac:d8cf:20e2::1}"
export API_URL="${API_URL:-http://127.0.0.1:3000}"
export NETWORK_ID="${NETWORK_ID:-8056c2e21c000001}"
export FILE_TOKEN="${FILE_TOKEN:-/run/secrets/ztnet_token}"
export AUTO_ALLOW_ZT="${AUTO_ALLOW_ZT:-true}"
export REFRESH="${REFRESH:-30s}"
export TIMEOUT="${TIMEOUT:-5s}"
export TTL="${TTL:-60}"
export DNS_UPSTREAM="${DNS_UPSTREAM:-1.1.1.1 8.8.8.8}"

if [[ -t 1 ]]; then
  C_RESET='\033[0m'; C_RED='\033[31m'; C_GREEN='\033[32m'; C_YELLOW='\033[33m'; C_BLUE='\033[34m'; C_BOLD='\033[1m'
else
  C_RESET=''; C_RED=''; C_GREEN=''; C_YELLOW=''; C_BLUE=''; C_BOLD=''
fi

log() { printf "%b[INFO]%b %s\n" "$C_BLUE" "$C_RESET" "$*"; }
ok() { printf "%b[ OK ]%b %s\n" "$C_GREEN" "$C_RESET" "$*"; }
warn() { printf "%b[WARN]%b %s\n" "$C_YELLOW" "$C_RESET" "$*" >&2; }
fail() { printf "%b[FAIL]%b %s\n" "$C_RED" "$C_RESET" "$*" >&2; exit 1; }

cleanup() {
  [[ -n "$WORKDIR" && -d "$WORKDIR" ]] && rm -rf "$WORKDIR"
}
trap cleanup EXIT

require_cmd() { command -v "$1" >/dev/null 2>&1 || fail "Required command not found: $1"; }
ensure_root() { [[ "$EUID" -eq 0 ]] || fail "Run installer with sudo/root"; }

usage() {
  cat <<USAGE
Usage: $0 [options]

Options:
  --delete        Remove coredns-ztnet from system (requires Yes/Y confirmation)
  --ipv6_disable  Disable IPv6 bind/hosts configuration in generated Corefile
  --zt_full       Full install: install ZeroTier One if missing + patch service with -U
  -h, --help      Show this help
USAGE
}

parse_args() {
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --delete) DELETE_MODE=true ;;
      --ipv6_disable) IPV6_DISABLE=true ;;
      --zt_full) ZT_FULL=true ;;
      -h|--help)
        usage
        exit 0
        ;;
      *) fail "Unknown argument: $1" ;;
    esac
    shift
  done
}

confirm_delete() {
  local answer=""
  read -r -p "Type Yes or Y to confirm deletion: " answer
  case "$answer" in
    Yes|Y) return 0 ;;
    *) fail "Deletion cancelled by user" ;;
  esac
}

run_delete() {
  confirm_delete
  log "Removing coredns-ztnet installation"
  if command -v systemctl >/dev/null 2>&1; then
    systemctl disable --now coredns-ztnet.service || true
    systemctl daemon-reload || true
  fi
  rm -f /usr/sbin/coredns
  rm -f /usr/bin/ztnetool
  rm -f /lib/systemd/system/coredns-ztnet.service
  rm -rf /etc/coredns
  ok "coredns-ztnet removed"
}

prompt_required() {
  local var_name="$1" prompt="$2" value=""
  while true; do
    read -r -p "$prompt" value
    value="${value//[$'\r\n']/}"
    if [[ -n "$value" ]]; then
      printf -v "$var_name" '%s' "$value"
      return 0
    fi
    warn "This field is required"
  done
}

prompt_default() {
  local var_name="$1" prompt="$2" def="$3" value=""
  read -r -p "$prompt [$def]: " value
  printf -v "$var_name" '%s' "${value:-$def}"
}

ensure_coredns_identity() {
  if ! getent group coredns >/dev/null; then
    log "Creating group coredns"
    groupadd --system coredns
  fi
  if ! getent passwd coredns >/dev/null; then
    log "Creating user coredns"
    useradd --system --gid coredns --home-dir /nonexistent --shell /usr/sbin/nologin coredns 2>/dev/null || \
      useradd --system --gid coredns --home-dir /nonexistent --shell /bin/false coredns
  fi
  ok "User/group coredns:coredns is ready"
}

install_zerotier() {
  log "Installing ZeroTier One"
  curl -s 'https://raw.githubusercontent.com/zerotier/ZeroTierOne/main/doc/contact%40zerotier.com.gpg' | gpg --import
  local z
  z="$(curl -s 'https://install.zerotier.com/' | gpg)"
  [[ -n "$z" ]] || fail "Failed to retrieve signed ZeroTier install script"
  echo "$z" | bash
  ok "ZeroTier One installed"
}

install_dependencies() {
  log "Installing dependencies"
  apt-get update
  apt-get install -y git make build-essential ca-certificates curl dnsutils net-tools iproute2 golang gnupg ripgrep
  ok "Dependencies installed"
}

check_zerotier() {
  if ! command -v zerotier-one >/dev/null 2>&1; then
    if [[ "$ZT_FULL" == true ]]; then
      install_zerotier
    else
      fail "zerotier-one is not installed. Re-run with --zt_full for full installation"
    fi
  fi

  local svc="/lib/systemd/system/zerotier-one.service"
  [[ -f "$svc" ]] || fail "Service file not found: $svc"

  if [[ "$ZT_FULL" == true ]] && ! rg -q '/usr/sbin/zerotier-one -U' "$svc"; then
    log "Patching zerotier-one.service with -U"
    sed -i 's#/usr/sbin/zerotier-one#/usr/sbin/zerotier-one -U#g' "$svc"
    systemctl daemon-reload
    systemctl restart zerotier-one.service
  fi

  if ifconfig 2>/dev/null | rg -q '^zt'; then
    ok "ZeroTier interface zt* is present"
    return 0
  fi

  systemctl restart zerotier-one.service
  sleep 2
  if ! ifconfig 2>/dev/null | rg -q '^zt'; then
    fail "ZeroTier interface zt* is missing"
  fi

  ok "ZeroTier service checked and zt* interface is available"
}

check_port_bind() {
  local ipv4_esc
  ipv4_esc="${EXITNODE_IPV4//./\.}"
  if [[ "$IPV6_DISABLE" == true ]]; then
    log "Checking port 53 availability on ${EXITNODE_IPV4}"
    local hits
    hits="$(ss -H -lunpt 2>/dev/null | awk '{print $5}' | rg "^${ipv4_esc}:53$" || true)"
    [[ -z "$hits" ]] || fail "Port 53 is already in use on IPv4 bind address"
  else
    log "Checking port 53 availability on ${EXITNODE_IPV4} and ${EXITNODE_IPV6}"
    local hits
    hits="$(ss -H -lunpt 2>/dev/null | awk '{print $5}' | rg "^(${ipv4_esc}|\[${EXITNODE_IPV6}\]):53$" || true)"
    [[ -z "$hits" ]] || fail "Port 53 is already in use on one of the bind addresses"
  fi
  ok "Port 53 is free on target bind addresses"
}

validate_bool() { case "${1,,}" in true|false) return 0 ;; *) return 1 ;; esac; }

collect_inputs() {
  echo -e "${C_BOLD}=== Installation parameters ===${C_RESET}"
  prompt_default API_URL "1) API_URL" "http://127.0.0.1:3000"
  prompt_required TOKEN_INPUT "2) API TOKEN (*): "
  prompt_required NETWORK_ID "3) NETWORK_ID (*): "
  prompt_default ZONE "4) ZONE" "ztnet.local"

  local extra=""
  prompt_default extra "5) Configure additional parameters? [Yes/No]" "No"
  if [[ "${extra,,}" == "yes" || "${extra,,}" == "y" ]]; then
    prompt_default EXITNODE_IPV4 "6) EXITNODE_IPV4" "192.168.55.1"
    if [[ "$IPV6_DISABLE" == false ]]; then
      prompt_default EXITNODE_IPV6 "7) EXITNODE_IPV6" "fc4e:1d7b:a5ac:d8cf:20e2::1"
    fi
    prompt_default AUTO_ALLOW_ZT "8) AUTO_ALLOW_ZT [true/false]" "true"
    validate_bool "$AUTO_ALLOW_ZT" || fail "AUTO_ALLOW_ZT must be true or false"
    prompt_default REFRESH "9) REFRESH" "30s"
    prompt_default TIMEOUT "10) TIMEOUT" "5s"
    prompt_default TTL "11) TTL" "60"
    prompt_default DNS_UPSTREAM "12) DNS_UPSTREAM" "1.1.1.1 8.8.8.8"
  fi
}

write_corefile() {
  local bind_addrs host_entries root_bind
  if [[ "$IPV6_DISABLE" == true ]]; then
    bind_addrs="${EXITNODE_IPV4}"
    host_entries="        ${EXITNODE_IPV4} ${ZONE}"
    root_bind="127.0.0.1 ${EXITNODE_IPV4}"
  else
    bind_addrs="${EXITNODE_IPV4} ${EXITNODE_IPV6}"
    host_entries="        ${EXITNODE_IPV4} ${ZONE}\n        ${EXITNODE_IPV6} ${ZONE}"
    root_bind="127.0.0.1 ${EXITNODE_IPV4} ${EXITNODE_IPV6}"
  fi

  log "Writing /etc/coredns/Corefile"
  install -d -m 0750 /etc/coredns
  cat > /etc/coredns/Corefile <<CORE
${ZONE} {
    bind ${bind_addrs}
    hosts {
$(printf "%b\n" "$host_entries")
    }
    ztnet {
        api_url ${API_URL}
        network_id ${NETWORK_ID}
        zone ${ZONE}
        token_file ${FILE_TOKEN}
        auto_allow_zt ${AUTO_ALLOW_ZT}
        refresh ${REFRESH}
        timeout ${TIMEOUT}
        ttl ${TTL}
    }
    prometheus :9153
    errors
    log
}

. {
    bind ${root_bind}
    forward . ${DNS_UPSTREAM}
    cache
}
CORE
  chmod 0640 /etc/coredns/Corefile
  chown root:coredns /etc/coredns/Corefile
  ok "Corefile updated"
}

install_project() {
  log "Cloning repository: ${REPO_URL}"
  WORKDIR="$(mktemp -d /tmp/ztnet-dns-install.XXXXXX)"
  git clone --depth=1 "$REPO_URL" "$WORKDIR/repo"

  pushd "$WORKDIR/repo" >/dev/null
  log "Running verify/build/install targets"
  make verify
  make build-coredns
  make install-binary install-config install-helper
  popd >/dev/null
}

start_service() {
  if command -v setcap >/dev/null 2>&1; then
    setcap 'cap_net_bind_service=+ep' /usr/sbin/coredns || true
  fi
  systemctl daemon-reload
  systemctl enable --now coredns-ztnet.service
  systemctl restart coredns-ztnet.service
  ok "Service started"
  systemctl --no-pager --full status coredns-ztnet.service || true
}

main() {
  parse_args "$@"
  ensure_root

  if [[ "$DELETE_MODE" == true ]]; then
    run_delete
    return 0
  fi

  collect_inputs
  install_dependencies

  require_cmd rg
  require_cmd ss
  require_cmd ifconfig
  require_cmd systemctl

  ensure_coredns_identity
  check_zerotier
  check_port_bind
  install_project
  write_corefile

  log "Writing token via ztnetool"
  /usr/bin/ztnetool -t "$TOKEN_INPUT" --token-file "$FILE_TOKEN" --corefile /etc/coredns/Corefile
  /usr/bin/ztnetool -c --api-url "$API_URL" --network-id "$NETWORK_ID" --token-file "$FILE_TOKEN"

  start_service
  ok "Installation completed"
}

main "$@"
