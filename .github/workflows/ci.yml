name: CI

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  pull_request:
    branches: ["main"]

permissions:
  contents: write   # для создания release и загрузки артефактов

env:
  GO_VERSION: "1.22"
  COREDNS_VERSION: "v1.11.3"
  PLUGIN_MODULE: "github.com/CleoWixom/ztnet-dns"

# ─────────────────────────────────────────────────────────────────────────────
jobs:

# ═══════════════════════════════════════════════════════════════════════════
# JOB 1 — Тесты плагина
#
# CoreDNS плагины тестируются прямо в репозитории плагина.
# CoreDNS приходит как обычная Go-зависимость через go.mod:
#   require github.com/coredns/coredns v1.11.3
#
# В тестах используются:
#   dnstest.NewRecorder(&test.ResponseWriter{})  ← mock DNS writer
#   test.Case{Qname:..., Qtype:..., Answer:...}  ← DNS test cases
#   test.SortAndCheck(rec.Msg, tc)               ← валидация ответа
#   caddy.NewTestController("dns", `...`)        ← тест парсинга Corefile
#   httptest.NewServer(...)                      ← mock ZTNET API
# ═══════════════════════════════════════════════════════════════════════════
  test:
    name: Test
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download modules
        run: go mod download

      # Проверяем что go.sum актуален — защита от drift
      - name: Verify go.sum
        run: go mod verify

      # Базовая статическая проверка
      - name: go vet
        run: go vet ./...

      # Полный линтер — документ требует golangci-lint без предупреждений
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          args: --timeout=5m

      # ── Unit + Integration тесты с race detector ───────────────────────
      #
      # Что проверяется (из ztnet_test.go):
      #
      # secret.go:
      #   TestLoadToken_File, TestLoadToken_File_Empty, TestLoadToken_File_Missing
      #   TestLoadToken_Env, TestLoadToken_Env_Unset, TestLoadToken_Inline
      #   TestLoadToken_HotRotation
      #
      # cache.go:
      #   TestCacheSnapshot, TestCacheConcurrency (50 readers / 5 writers → -race),
      #   TestCacheLen
      #
      # ipv6.go:
      #   TestComputeRFC4193, TestCompute6plane, TestComputeRFC4193_Invalid
      #
      # access.go:
      #   TestAllowedNets_Contains_IPv4, TestAllowedNets_Contains_IPv6
      #   TestAllowedNets_Reject_External, TestAllowedNets_Loopback_Always
      #   TestAllowedNets_InvalidCIDR
      #   TestExtractSourceIP_UDP, TestExtractSourceIP_TCP
      #   TestServeDNS_REFUSED_External, TestServeDNS_REFUSED_NilSrcIP
      #   TestServeDNS_Allowed_ZT, TestServeDNS_Allowed_Loopback
      #   TestServeDNS_NilAllowlist_StrictOff, TestServeDNS_NilAllowlist_StrictOn
      #   TestRefresh_AutoCIDRFromRoutes, TestRefresh_SkipsViaRoutes
      #   TestRefresh_StaleAllowedOnBuildError
      #   TestCache_SetIsAllowed_Atomic
      #
      # ztnet.go (ServeDNS через dnstest.NewRecorder + test.ResponseWriter):
      #   TestServeDNS_A, TestServeDNS_AAAA, TestServeDNS_ANY
      #   TestServeDNS_SOA, TestServeDNS_NXDOMAIN
      #   TestServeDNS_OutOfZone, TestServeDNS_NoQuestion
      #   TestServeDNS_UnknownType
      #   TestServeDNS_DNSSD_TXT, TestServeDNS_DNSSD_Custom
      #   TestServeDNS_ShortName_Hit, TestServeDNS_ShortName_Miss
      #   TestServeDNS_ShortName_Off, TestIsBareName
      #
      # api.go (интеграционные через httptest.NewServer):
      #   TestFetchMembers_Success, TestFetchMembers_OnlyAuthorized
      #   TestFetchMembers_401, TestFetchMembers_500_ThenOK
      #   TestFetchMembers_Timeout
      #   TestRefresh_TokenRotation, TestRefresh_StaleOnError
      #
      - name: Run tests (-race)
        run: |
          go test \
            -race \
            -count=1 \
            -timeout=120s \
            -v \
            ./...

      # Отдельный прогон для покрытия (race уже проверен выше)
      - name: Coverage report
        run: |
          go test \
            -coverprofile=coverage.out \
            -covermode=atomic \
            ./...
          go tool cover -func=coverage.out | grep -E "^total|ztnet"

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage.out
          retention-days: 14

# ═══════════════════════════════════════════════════════════════════════════
# JOB 2 — Сборка CoreDNS с плагином + упаковка в .deb (Ubuntu 24.04 amd64)
#
# Схема:
#   1. Клонируем CoreDNS v1.11.3
#   2. Вставляем строку "ztnet:..." в plugin.cfg перед forward
#   3. go get <plugin>@<версия>  — подтягиваем код плагина
#   4. go generate               — регенерирует zplugin.go (список плагинов)
#   5. CGO_ENABLED=0 go build    — статический бинарь coredns
#   6. nfpm package              — собираем .deb
#
# .deb устанавливает:
#   /usr/sbin/coredns            ← бинарь
#   /etc/coredns/Corefile        ← конфиг (config-file, не перезаписывается)
#   /lib/systemd/system/coredns-ztnet.service
# ═══════════════════════════════════════════════════════════════════════════
  build-deb:
    name: Build .deb (amd64)
    runs-on: ubuntu-24.04
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false   # у этого job другой GOPATH — кэш CoreDNS большой

      # ── Вычислить версию пакета ────────────────────────────────────────
      # На теге vX.Y.Z → "X.Y.Z"
      # На ветке        → "0.0.0+<short-sha>"
      - name: Compute package version
        id: version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            echo "pkg=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"
            echo "plugin_ref=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          else
            SHA=$(git rev-parse --short HEAD)
            echo "pkg=0.0.0+${SHA}" >> "$GITHUB_OUTPUT"
            echo "plugin_ref=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"
          fi

      # ── Клонируем CoreDNS ─────────────────────────────────────────────
      - name: Clone CoreDNS ${{ env.COREDNS_VERSION }}
        run: |
          git clone --depth=1 --branch "$COREDNS_VERSION" \
            https://github.com/coredns/coredns.git /tmp/coredns

      # ── Вшиваем плагин в plugin.cfg ───────────────────────────────────
      # Плагин должен стоять ПЕРЕД forward — это критично для short_names.
      # sed ищет строку "^forward" и вставляет нашу строку перед ней.
      - name: Inject plugin into plugin.cfg
        working-directory: /tmp/coredns
        run: |
          sed -i "/^forward/i ztnet:${PLUGIN_MODULE}" plugin.cfg
          # Убеждаемся что вставка прошла
          grep -n "ztnet\|forward" plugin.cfg

      # ── Подтягиваем код плагина ───────────────────────────────────────
      # На теге используем тег, на PR/main — конкретный коммит
      - name: Add plugin dependency
        working-directory: /tmp/coredns
        run: |
          go get "$PLUGIN_MODULE@${{ steps.version.outputs.plugin_ref }}"
          go mod tidy

      # ── go generate: регенерируем zplugin.go ──────────────────────────
      - name: go generate
        working-directory: /tmp/coredns
        run: go generate

      # ── Компилируем статический бинарь ────────────────────────────────
      - name: Build coredns binary (amd64)
        working-directory: /tmp/coredns
        env:
          CGO_ENABLED: "0"
          GOOS: linux
          GOARCH: amd64
        run: |
          go build \
            -ldflags="-s -w -X github.com/coredns/coredns/coremain.GitVersion=${{ steps.version.outputs.pkg }}" \
            -trimpath \
            -o /tmp/coredns-bin \
            .

          # Проверяем что плагин ztnet действительно вшит
          /tmp/coredns-bin -plugins | grep ztnet

      # ── Устанавливаем nfpm ────────────────────────────────────────────
      - name: Install nfpm
        run: |
          curl -sSfL \
            https://github.com/goreleaser/nfpm/releases/latest/download/nfpm_$(uname -s)_$(uname -m).tar.gz \
            | tar -xz -C /usr/local/bin nfpm
          nfpm --version

      # ── Собираем .deb ─────────────────────────────────────────────────
      - name: Package .deb
        env:
          PKG_VERSION: ${{ steps.version.outputs.pkg }}
        run: |
          mkdir -p dist
          PKG_VERSION="$PKG_VERSION" nfpm package \
            --config packaging/nfpm.yaml \
            --packager deb \
            --target dist/

      - name: Show .deb info
        run: |
          DEB=$(ls dist/*.deb)
          echo "Package: $DEB"
          dpkg-deb --info "$DEB"
          dpkg-deb --contents "$DEB"

      # ── Артефакт для всех push ─────────────────────────────────────────
      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: coredns-ztnet-deb-amd64
          path: dist/*.deb
          retention-days: 30

      # ── Release asset (только при push тега) ──────────────────────────
      - name: Attach .deb to GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.deb
          generate_release_notes: true
