#!/usr/bin/env bash
set -euo pipefail

REPO_URL="https://github.com/CleoWixom/ztnet-dns.git"
WORKDIR=""

export ZONE="${ZONE:-ztnet.local}"
export NODE_IPV4="${NODE_IPV4:-192.168.55.1}"
export NODE_IPV6="${NODE_IPV6:-fc4e:1d7b:a5ac:d8cf:20e2::1}"
export API_URL="${API_URL:-http://127.0.0.1:3000}"
export NETWORK_ID="${NETWORK_ID:-8056c2e21c000001}"
export FILE_TOKEN="${FILE_TOKEN:-/run/secrets/ztnet_token}"
export AUTO_ALLOW_ZT="${AUTO_ALLOW_ZT:-true}"
export REFRESH="${REFRESH:-30s}"
export TIMEOUT="${TIMEOUT:-5s}"
export TTL="${TTL:-60}"
export DNS_UPSTREAM="${DNS_UPSTREAM:-1.1.1.1 8.8.8.8}"

if [[ -t 1 ]]; then
  C_RESET='\033[0m'; C_RED='\033[31m'; C_GREEN='\033[32m'; C_YELLOW='\033[33m'; C_BLUE='\033[34m'; C_BOLD='\033[1m'
else
  C_RESET=''; C_RED=''; C_GREEN=''; C_YELLOW=''; C_BLUE=''; C_BOLD=''
fi

log() { printf "%b[INFO]%b %s\n" "$C_BLUE" "$C_RESET" "$*"; }
ok() { printf "%b[ OK ]%b %s\n" "$C_GREEN" "$C_RESET" "$*"; }
warn() { printf "%b[WARN]%b %s\n" "$C_YELLOW" "$C_RESET" "$*" >&2; }
fail() { printf "%b[FAIL]%b %s\n" "$C_RED" "$C_RESET" "$*" >&2; exit 1; }

cleanup() {
  [[ -n "$WORKDIR" && -d "$WORKDIR" ]] && rm -rf "$WORKDIR"
}
trap cleanup EXIT

require_cmd() { command -v "$1" >/dev/null 2>&1 || fail "Требуется команда: $1"; }

ensure_root() {
  [[ "$EUID" -eq 0 ]] || fail "Запустите installer через sudo/root"
}

prompt_required() {
  local var_name="$1"; local prompt="$2"; local value=""
  while true; do
    read -r -p "$prompt" value
    value="${value//[$'\r\n']/}"
    if [[ -n "$value" ]]; then
      printf -v "$var_name" '%s' "$value"
      return 0
    fi
    warn "Поле обязательно"
  done
}

prompt_default() {
  local var_name="$1"; local prompt="$2"; local def="$3"; local value=""
  read -r -p "$prompt [$def]: " value
  value="${value:-$def}"
  printf -v "$var_name" '%s' "$value"
}

ensure_coredns_identity() {
  if ! getent group coredns >/dev/null; then
    log "Создаю группу coredns"
    groupadd --system coredns
  fi
  if ! getent passwd coredns >/dev/null; then
    log "Создаю пользователя coredns"
    useradd --system --gid coredns --home-dir /nonexistent --shell /usr/sbin/nologin coredns 2>/dev/null || \
      useradd --system --gid coredns --home-dir /nonexistent --shell /bin/false coredns
  fi
  ok "Пользователь/группа coredns:coredns готовы"
}

install_dependencies() {
  log "Установка зависимостей"
  apt-get update
  apt-get install -y git make build-essential ca-certificates curl dnsutils net-tools iproute2 golang
  ok "Зависимости установлены"
}

check_zerotier() {
  if ! command -v zerotier-one >/dev/null 2>&1; then
    fail "zerotier-one не установлен. Установите ZeroTier One:\ncurl -s 'https://raw.githubusercontent.com/zerotier/ZeroTierOne/main/doc/contact%40zerotier.com.gpg' | gpg --import && \\
if z=$(curl -s 'https://install.zerotier.com/' | gpg); then echo \"$z\" | sudo bash; fi"
  fi

  if ! ifconfig 2>/dev/null | rg -q '^zt'; then
    local svc="/lib/systemd/system/zerotier-one.service"
    [[ -f "$svc" ]] || fail "Не найден $svc для патча -U"

    if ! rg -q '/usr/sbin/zerotier-one -U' "$svc"; then
      log "Патчу zerotier-one.service: добавляю аргумент -U"
      sed -i 's#/usr/sbin/zerotier-one#/usr/sbin/zerotier-one -U#g' "$svc"
    fi

    systemctl daemon-reload
    systemctl restart zerotier-one.service
    sleep 2
    if ! ifconfig 2>/dev/null | rg -q '^zt'; then
      fail "После патча интерфейс zt* не появился"
    fi
  fi
  ok "ZeroTier проверен (zt* интерфейс найден)"
}

check_port_bind() {
  log "Проверка порта 53 на адресах ${NODE_IPV4} ${NODE_IPV6}"
  local hits
  hits="$(ss -H -lunpt 2>/dev/null | awk '{print $5}' | rg "^(${NODE_IPV4}|\[${NODE_IPV6}\]):53$" || true)"
  if [[ -n "$hits" ]]; then
    fail "Порт 53 уже занят на одном из bind-адресов"
  fi
  ok "Порт 53 свободен на target bind-адресах"
}

validate_bool() {
  case "${1,,}" in true|false) return 0;; *) return 1;; esac
}

collect_inputs() {
  echo -e "${C_BOLD}=== Параметры установки ===${C_RESET}"
  prompt_default API_URL "1) Ввод API_URL" "http://127.0.0.1:3000"
  prompt_required TOKEN_INPUT "2) Ввод TOKEN API (*): "
  prompt_required NETWORK_ID "3) Ввод NETWORK_ID (*): "
  prompt_default ZONE "4) Ввод ZONE" "ztnet.local"

  local extra=""
  prompt_default extra "5) Дополнительные параметры настроить? [Yes/No]" "No"
  if [[ "${extra,,}" == "yes" || "${extra,,}" == "y" ]]; then
    prompt_default NODE_IPV4 "6) Ввод NODE_IPV4" "192.168.55.1"
    prompt_default NODE_IPV6 "7) Ввод NODE_IPV6" "fc4e:1d7b:a5ac:d8cf:20e2::1"
    prompt_default AUTO_ALLOW_ZT "8) Ввод AUTO_ALLOW_ZT [true/false]" "true"
    validate_bool "$AUTO_ALLOW_ZT" || fail "AUTO_ALLOW_ZT должен быть true|false"
    prompt_default REFRESH "9) Ввод REFRESH" "30s"
    prompt_default TIMEOUT "10) Ввод TIMEOUT" "5s"
    prompt_default TTL "11) Ввод TTL" "60"
    prompt_default DNS_UPSTREAM "12) Ввод DNS_UPSTREAM" "1.1.1.1 8.8.8.8"
  else
    AUTO_ALLOW_ZT="true"
  fi
}

write_corefile() {
  log "Записываю /etc/coredns/Corefile"
  install -d -m 0750 /etc/coredns
  cat > /etc/coredns/Corefile <<CORE
${ZONE} {
    bind ${NODE_IPV4} ${NODE_IPV6}
    hosts {
        ${NODE_IPV4} ${ZONE}
        ${NODE_IPV6} ${ZONE}
    }
    ztnet {
        api_url ${API_URL}
        network_id ${NETWORK_ID}
        zone ${ZONE}
        token_file ${FILE_TOKEN}
        auto_allow_zt ${AUTO_ALLOW_ZT}
        refresh ${REFRESH}
        timeout ${TIMEOUT}
        ttl ${TTL}
    }
    prometheus :9153
    errors
    log
}

. {
    bind 127.0.0.1 ${NODE_IPV4} ${NODE_IPV6}
    forward . ${DNS_UPSTREAM}
    cache
}
CORE
  chmod 0640 /etc/coredns/Corefile
  chown root:coredns /etc/coredns/Corefile
  ok "Corefile обновлен"
}

main() {
  ensure_root
  require_cmd rg
  require_cmd ss
  require_cmd ifconfig
  require_cmd systemctl

  collect_inputs
  install_dependencies
  ensure_coredns_identity
  check_zerotier
  check_port_bind

  WORKDIR="$(mktemp -d /tmp/ztnet-dns-install.XXXXXX)"
  log "Клонирую репозиторий: ${REPO_URL}"
  git clone --depth=1 "$REPO_URL" "$WORKDIR/repo"
  pushd "$WORKDIR/repo" >/dev/null

  log "Сборка и установка CoreDNS+plugin"
  make install
  write_corefile

  log "Записываю токен через ztnetool"
  /usr/bin/ztnetool -t "$TOKEN_INPUT" --token-file "$FILE_TOKEN" --corefile /etc/coredns/Corefile
  /usr/bin/ztnetool -c --api-url "$API_URL" --network-id "$NETWORK_ID" --token-file "$FILE_TOKEN"

  systemctl daemon-reload
  systemctl enable --now coredns-ztnet.service
  systemctl restart coredns-ztnet.service
  ok "Установка завершена"
  systemctl --no-pager --full status coredns-ztnet.service || true

  popd >/dev/null
}

main "$@"
